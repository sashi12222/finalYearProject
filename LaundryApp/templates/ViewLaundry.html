{% extends 'base.html' %}
{% load static %}

{% block title %}My Orders - Laundry at Ease{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3><i class="bi bi-bag-check me-2"></i>My Laundry Orders</h3>
                <a href="{% url 'LaundryService' %}" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i> New Order</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    {{ data|safe }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Content will be dynamically populated -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // JavaScript to enhance the table generated by the backend
    document.addEventListener('DOMContentLoaded', function() {
        // Find all tables in the card body
        const tables = document.querySelectorAll('.card-body table');
        
        // Add Bootstrap classes to each table
        tables.forEach(table => {
            // Add classes to table
            table.classList.add('table', 'table-striped', 'table-hover', 'table-responsive');
            table.style.width = '100%';
            
            // Create table header if it doesn't exist
            if (!table.querySelector('thead')) {
                const headerRow = table.rows[0];
                const thead = document.createElement('thead');
                thead.appendChild(headerRow.cloneNode(true));
                table.insertBefore(thead, table.firstChild);
                headerRow.remove();
            }
            
            // Style the table header
            const headerRow = table.querySelector('thead tr');
            if (headerRow) {
                headerRow.querySelectorAll('th, td').forEach(cell => {
                    cell.style.backgroundColor = 'var(--primary-color)';
                    cell.style.color = 'white';
                    cell.style.fontWeight = 'bold';
                });
            }
            
            // Add classes to tbody if it doesn't exist
            if (!table.querySelector('tbody')) {
                const tbody = document.createElement('tbody');
                Array.from(table.querySelectorAll('tr')).forEach((row, index) => {
                    if (index > 0) { // Skip header row
                        tbody.appendChild(row.cloneNode(true));
                    }
                });
                
                // Remove all rows except header
                Array.from(table.querySelectorAll('tr')).forEach((row, index) => {
                    if (index > 0) { // Skip header row
                        row.remove();
                    }
                });
                
                table.appendChild(tbody);
            }
            
            // Add Bootstrap classes to status badges
            const statusCells = table.querySelectorAll('tbody tr td:nth-last-child(2)');
            statusCells.forEach(cell => {
                const status = cell.textContent.trim();
                if (status === 'Pending') {
                    cell.innerHTML = '<span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i>Pending</span>';
                } else if (status === 'Completed') {
                    cell.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Completed</span>';
                } else if (status === 'Processing') {
                    cell.innerHTML = '<span class="badge bg-info"><i class="bi bi-arrow-repeat me-1"></i>Processing</span>';
                }
            });
            
            // Make images responsive and clickable for larger view
            const images = table.querySelectorAll('img');
            images.forEach(img => {
                // Save the original src
                const originalSrc = img.src;
                
                // Create a wrapper for the image
                const wrapper = document.createElement('div');
                wrapper.classList.add('text-center');
                img.parentNode.insertBefore(wrapper, img);
                wrapper.appendChild(img);
                
                // Style the image
                img.classList.add('img-thumbnail-custom');
                img.setAttribute('data-bs-toggle', 'modal');
                img.setAttribute('data-bs-target', '#orderDetailsModal');
                
                // Add click event to show the image in a modal
                img.addEventListener('click', function() {
                    // Get order details from the current row
                    const row = this.closest('tr');
                    const cells = row.querySelectorAll('td');
                    let orderDetails = '<div class="row">';
                    
                    // Left column with image
                    orderDetails += '<div class="col-md-6 text-center mb-3">';
                    orderDetails += '<img src="' + originalSrc + '" class="img-fluid rounded" style="max-height: 300px;">';
                    orderDetails += '</div>';
                    
                    // Right column with order details
                    orderDetails += '<div class="col-md-6">';
                    orderDetails += '<h5 class="border-bottom pb-2 mb-3">Order Information</h5>';
                    orderDetails += '<ul class="list-group list-group-flush">';
                    
                    // Extract information from the table row
                    if (cells[0]) orderDetails += '<li class="list-group-item"><strong>Order ID:</strong> ' + cells[0].textContent + '</li>';
                    if (cells[2]) orderDetails += '<li class="list-group-item"><strong>Order Date:</strong> ' + cells[2].textContent + '</li>';
                    if (cells[3]) orderDetails += '<li class="list-group-item"><strong>Service Type:</strong> ' + cells[3].textContent + '</li>';
                    
                    // Add status with appropriate badge
                    const statusCell = table.querySelector('tbody tr td:nth-last-child(2)');
                    if (statusCell) {
                        const status = statusCell.textContent.trim();
                        let statusBadge = '';
                        if (status === 'Pending') {
                            statusBadge = '<span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i>Pending</span>';
                        } else if (status === 'Completed') {
                            statusBadge = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Completed</span>';
                        } else if (status === 'Processing') {
                            statusBadge = '<span class="badge bg-info"><i class="bi bi-arrow-repeat me-1"></i>Processing</span>';
                        }
                        orderDetails += '<li class="list-group-item"><strong>Status:</strong> ' + statusBadge + '</li>';
                    }
                    
                    orderDetails += '</ul>';
                    orderDetails += '</div>';
                    orderDetails += '</div>';
                    
                    // Add items summary in another row
                    orderDetails += '<div class="row mt-3">';
                    orderDetails += '<div class="col-12">';
                    orderDetails += '<h5 class="border-bottom pb-2 mb-3">Items Summary</h5>';
                    orderDetails += '<div class="row">';
                    
                    // Create a list of items
                    const itemTypes = ['Shirts', 'T-Shirts', 'Shorts', 'Pants', 'Towels', 'Suits', 'Inner Wears', 'Kurtas', 'Paijamas', 'Skirts'];
                    for (let i = 0; i < itemTypes.length && i + 4 < cells.length; i++) {
                        const itemQuantity = cells[i + 4].textContent.trim();
                        if (itemQuantity && itemQuantity !== '0') {
                            orderDetails += '<div class="col-md-3 mb-2">';
                            orderDetails += '<div class="d-flex justify-content-between border-bottom pb-1">';
                            orderDetails += '<span>' + itemTypes[i] + ':</span>';
                            orderDetails += '<strong>' + itemQuantity + '</strong>';
                            orderDetails += '</div>';
                            orderDetails += '</div>';
                        }
                    }
                    
                    orderDetails += '</div>'; // End of items row
                    orderDetails += '</div>'; // End of col-12
                    orderDetails += '</div>'; // End of row
                    
                    // Update the modal content
                    document.getElementById('orderModalBody').innerHTML = orderDetails;
                    
                    // Update modal title
                    document.getElementById('orderDetailsModalLabel').textContent = 'Order #' + (cells[0] ? cells[0].textContent : '');
                });
            });
            
            // Improve table header titles - make them more readable
            if (table.querySelector('thead tr')) {
                const headerCells = table.querySelectorAll('thead tr th');
                const newTitles = [
                    'Order ID', 'Customer', 'Date', 'Service Type', 'Shirts', 'T-Shirts', 
                    'Shorts', 'Pants', 'Towels', 'Suits', 'Inner Wear', 'Kurtas', 
                    'Paijamas', 'Skirts', 'Image', 'Stain Analysis', 'Delivery Date', 'Address', 'Status'
                ];
                
                headerCells.forEach((cell, index) => {
                    if (index < newTitles.length) {
                        cell.textContent = newTitles[index];
                    }
                });
            }
            
            // Add action buttons in the last column
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const lastCell = row.cells[row.cells.length - 1];
                if (lastCell && lastCell.querySelector('img')) {
                    // This is an image cell, add view button to the previous cell
                    const imageCell = lastCell;
                    imageCell.style.textAlign = 'center';
                    
                    // Create view button
                    const viewBtn = document.createElement('button');
                    viewBtn.classList.add('btn', 'btn-sm', 'btn-outline-primary', 'mt-2');
                    viewBtn.innerHTML = '<i class="bi bi-eye"></i> View';
                    viewBtn.setAttribute('data-bs-toggle', 'modal');
                    viewBtn.setAttribute('data-bs-target', '#orderDetailsModal');
                    viewBtn.addEventListener('click', function() {
                        imageCell.querySelector('img').click();
                    });
                    
                    imageCell.appendChild(document.createElement('br'));
                    imageCell.appendChild(viewBtn);
                }
            });
        });
    });
</script>
{% endblock %} 